
<!doctype html>
<html lang="en">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡§Ü‡§®‡§Ç‡§¶ ‡§µ‡§®‡§Æ‡•ç ‚Äî Society Portal</title>
  <link rel="icon" href="logo.svg" type="image/svg+xml">
  <style>
    :root{--accent:#0b7285;--muted:#666;--nav-height:50px}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#222;padding-top:var(--nav-height)}
    html{scroll-behavior:smooth;scroll-padding-top:var(--nav-height)}
    header{background:linear-gradient(90deg, #f8fdff, #eef9fb);border-bottom:1px solid #eee;padding:16px 20px}
    .container{max-width:980px;margin:18px auto;padding:0 16px}
    .brand{display:flex;align-items:center;gap:8px}
    .brand h1{font-size:14px;margin:0;font-weight:600}
    .brand .small{display:none}
    nav{position:fixed;top:0;left:0;right:0;background:#fff;border-bottom:1px solid #e0e0e0;box-shadow:0 2px 4px rgba(0,0,0,0.08);z-index:1000;height:var(--nav-height);display:flex;align-items:center;justify-content:space-between;padding:0 20px}
    nav .brand{flex:1}
    nav .nav-links{display:flex;gap:20px}
    nav a{color:var(--accent);text-decoration:none;font-weight:600;font-size:14px;transition:color 0.2s;white-space:nowrap}
    nav a:hover{color:#0a5f6d}
    .hamburger{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:8px;background:none;border:none}
    .hamburger span{display:block;width:24px;height:2px;background:var(--accent);transition:all 0.3s}
    .hamburger.active span:nth-child(1){transform:rotate(45deg) translate(6px, 6px)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(6px, -6px)}
    main{padding:12px 0}
    .card{background:#fff;border:1px solid #eee;border-radius:8px;padding:14px;margin-bottom:14px;box-shadow:0 1px 3px rgba(20,20,20,0.03)}
    h2{margin:6px 0 12px 0}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
    /* Directory table */
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type=search],select{padding:8px;border-radius:6px;border:1px solid #ddd}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #f1f1f1;font-size:14px}
    th{background:#fafafa}
    th[data-sort]:hover{background:#f0f0f0}
    .sort-indicator{display:inline-block;margin-left:4px;opacity:0.3;font-size:11px}
    .sort-indicator.active{opacity:1;color:var(--accent)}
    .category-pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f1f8f9;color:var(--accent);font-weight:600;font-size:12px}
    .small{font-size:13px;color:var(--muted)}
    .notice{background:#fffbe6;border-left:4px solid #ffd43b;padding:10px;border-radius:6px}
    footer{padding:20px;text-align:center;color:#888;font-size:13px}
    .loader{width:28px;height:28px;border-radius:50%;border:4px solid #eee;border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:768px){
      nav .brand h1{display:block;font-size:12px}
      nav{padding:0 12px}
      .hamburger{display:flex}
      nav .nav-links{position:fixed;top:var(--nav-height);left:0;right:0;background:#fff;flex-direction:column;gap:0;padding:0;box-shadow:0 4px 6px rgba(0,0,0,0.1);max-height:0;overflow:hidden;transition:max-height 0.3s ease}
      nav .nav-links.active{max-height:300px}
      nav .nav-links a{padding:16px 20px;border-bottom:1px solid #f0f0f0;display:block}
      nav .nav-links a:hover{background:#f8f8f8}
    }
  </style>
</head>
<body>
  <nav>
    <div class="brand">
      <img src="logo.svg" alt="Anand Vanam Logo" width="32" height="32">
      <h1>Anand Vanam (CGHB) Colony - Sector 12, Nava Raipur</h1>
    </div>
    <button class="hamburger" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="nav-links">
      <a href="#about">About</a>
      <a href="#notices">Notices</a>
      <a href="#directory">Directory</a>
      <a href="#around-us">Around Us</a>
      <a href="#links">Links</a>
    </div>
  </nav>

  <main class="container">
    <div id="about" class="card">
      <h2>About</h2>
      <p class="small">Anand Vanam (CGHB) Colony - Sector 12, Nava Raipur is a calm, well-planned residential community built by the Chhattisgarh Housing Board in the heart of Nava Raipur. Designed with wide roads, green spaces, and modern infrastructure, Anand Vanam offers peaceful living with fast connectivity, sustainable planning, and a growing neighbourhood ecosystem.</p>
    </div>

    <section id="notices" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
        <h2 style="margin:0">Notice Board</h2>
        <span id="notices-last-updated" class="small" style="color:#666;;white-space:nowrap"></span>
      </div>
      <p class="small" style="margin-top:15px">All owners and residents are requested to refer to this.</p>
      <div id="notices-area">
        <p class="small">(No notices yet)</p>
      </div>
    </section>

    <section id="directory" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
        <h2 style="margin:0">Contact Directory</h2>
        <span id="directory-last-updated" class="small" style="color:#666;white-space:nowrap"></span>
      </div>

      <div class="controls" style="margin-bottom:12px">
        <input id="q" type="search" placeholder="Search name, contact, notes..." style="flex:1">
        <select id="filterCat"><option value="">All categories</option></select>
        <div id="loading" style="display:none"><span class="loader"></span></div>
      </div>

      <div id="table-wrap" style="overflow:auto">
        <table id="contacts-table">
          <thead>
            <tr>
              <th data-sort="category" style="cursor:pointer;user-select:none">Category <span class="sort-indicator"></span></th>
              <th data-sort="organization" style="cursor:pointer;user-select:none">Organization / Place / Service <span class="sort-indicator"></span></th>
              <th data-sort="person" style="cursor:pointer;user-select:none">Contact Person / Role <span class="sort-indicator"></span></th>
              <th data-sort="address" style="cursor:pointer;user-select:none">Address <span class="sort-indicator"></span></th>
              <th>Contact</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="around-us" class="card">
      <h2>Around Us</h2>
      <p class="small">Useful information about places and services in the vicinity of our society.</p>

      <div style="margin-top:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
          <h3 style="margin:0;font-size:1.1em">ü•¨ Vegetable Market Schedule</h3>
          <span id="vegmarket-last-updated" class="small" style="color:#666;white-space:nowrap"></span>
        </div>
        <div id="vegmarket-area">
          <p class="small">(Loading...)</p>
        </div>
      </div>

      <div style="margin-top:25px;padding-top:20px;border-top:1px solid #eee">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
          <h3 style="margin:0;font-size:1.1em">üöå Tatpar BRTS Schedule</h3>
          <span id="brts-last-updated" class="small" style="color:#666;white-space:nowrap"></span>
        </div>
        <div id="brts-area">
          <p class="small">(Loading...)</p>
        </div>
      </div>
    </section>

    <section id="links" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
        <h2 style="margin:0">Important Links</h2>
        <span id="links-last-updated" class="small" style="color:#666;white-space:nowrap"></span>
      </div>
      <p class="small" style="margin-top:15px">Quick access to important resources and websites.</p>
      <div id="links-area">
        <p class="small">(Loading...)</p>
      </div>
    </section>
  </main>

  <footer>
    <div class="container small">Made with love ‚ù§Ô∏è within the society ‚Ä¢ Hosted on GitHub</div>
    <div class="container small">¬© AVRWA ‚Äî All rights reserved.</div>
  </footer>

  <script>
    const LOCAL_CONTACT_DIR_URL = 'https://opensheet.elk.sh/1g6h5CWppUDYl01K3agjUanTWcP_jQdoPfHG3uJd4Ubc/Local';
    const NOTICE_URL = 'https://opensheet.elk.sh/1g6h5CWppUDYl01K3agjUanTWcP_jQdoPfHG3uJd4Ubc/Notice';
    const VEGMARKET_URL = 'https://opensheet.elk.sh/1g6h5CWppUDYl01K3agjUanTWcP_jQdoPfHG3uJd4Ubc/VegMarket';
    const BRTS_URL = 'https://opensheet.elk.sh/1g6h5CWppUDYl01K3agjUanTWcP_jQdoPfHG3uJd4Ubc/BRTS';
    const LINKS_URL = 'https://opensheet.elk.sh/1g6h5CWppUDYl01K3agjUanTWcP_jQdoPfHG3uJd4Ubc/Links';

    // Cache keys for localStorage
    const CACHE_KEYS = {
      contacts: 'avrwa_contacts_cache',
      notices: 'avrwa_notices_cache',
      vegmarket: 'avrwa_vegmarket_cache',
      brts: 'avrwa_brts_cache',
      links: 'avrwa_links_cache',
      contactsTimestamp: 'avrwa_contacts_timestamp',
      noticesTimestamp: 'avrwa_notices_timestamp',
      vegmarketTimestamp: 'avrwa_vegmarket_timestamp',
      brtsTimestamp: 'avrwa_brts_timestamp',
      linksTimestamp: 'avrwa_links_timestamp'
    };

    // Cache duration: 24 hour (in milliseconds)
    const CACHE_DURATION = 24 *60 * 60 * 1000;

    function el(tag, txt, cls){const e=document.createElement(tag); if(txt) e.textContent=txt; if(cls) e.className=cls; return e}

    // Cache management functions
    function saveToCache(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
        localStorage.setItem(key + '_timestamp', Date.now().toString());
      } catch (error) {
        console.warn('Failed to save to cache:', error);
      }
    }

    function getFromCache(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (error) {
        console.warn('Failed to read from cache:', error);
        return null;
      }
    }

    function getCacheAge(key) {
      try {
        const timestamp = localStorage.getItem(key + '_timestamp');
        if (!timestamp) return null;
        return Date.now() - parseInt(timestamp);
      } catch (error) {
        return null;
      }
    }

    function formatLastUpdated(timestamp, fromCache) {
      if (!timestamp) return '';

      const date = new Date(parseInt(timestamp));
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / (60 * 1000));
      const diffHours = Math.floor(diffMs / (60 * 60 * 1000));
      const diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));

      let timeAgo;
      if (diffMins < 1) {
        timeAgo = 'just now';
      } else if (diffMins < 60) {
        timeAgo = `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
      } else if (diffHours < 24) {
        timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      } else if (diffDays < 7) {
        timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      } else {
        timeAgo = date.toLocaleDateString();
      }

      // Green circle = fresh from API, Yellow circle = from cache
      const indicator = fromCache ? 'üü°' : 'üü¢';
      return `${indicator} ${timeAgo}`;
    }

    function updateLastUpdatedUI(elementId, timestamp, fromCache) {
      const element = document.getElementById(elementId);
      if (element && timestamp) {
        element.textContent = formatLastUpdated(timestamp, fromCache);
      }
    }

    // Fetch with retry logic
    async function fetchWithRetry(url, maxRetries = 3, delay = 1000) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          // Only log on final attempt
          if (i === maxRetries - 1) {
            console.warn(`Failed to fetch after ${maxRetries} attempts`);
            throw error;
          }
          // Wait before retrying (exponential backoff)
          await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
        }
      }
    }

    // Fetch data with cache fallback
    async function fetchDataWithCache(url, cacheKey) {
      try {
        // Try to fetch fresh data
        const data = await fetchWithRetry(url);
        // Save to cache
        saveToCache(cacheKey, data);
        return { data, fromCache: false };
      } catch (error) {
        // Silently fallback to cache
        const cachedData = getFromCache(cacheKey);
        if (cachedData) {
          return { data: cachedData, fromCache: true };
        }
        throw new Error('No data available');
      }
    }

    const tableBody = document.querySelector('#contacts-table tbody');
    const filterCat = document.getElementById('filterCat');
    const searchBox = document.getElementById('q');
    const loading = document.getElementById('loading');
    const noticesArea = document.getElementById('notices-area');

    let data = [];
    let notices = [];
    let sortColumn = 'category';
    let sortDirection = 'asc';

    function showLoading(show){loading.style.display = show ? 'inline-block' : 'none'}

    function renderTable(rows){
      tableBody.innerHTML = '';
      if(!rows.length){ tableBody.appendChild(el('tr').appendChild(el('td','No results',''))); return }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="category-pill">${escapeHtml(r.category||'')}</span></td>
          <td><strong>${escapeHtml(r.organization||'')}</strong></td>
          <td>${escapeHtml(r.person||'')}<div class="small">${escapeHtml(r.role||'')}</div></td>
          <td class="small">${escapeHtml(r.address||'')}</td>
          <td style="width:150px">${contactCell(r.phone, r.email)}</td>
          <td>${escapeHtml(r.notes||'')}</td>
        `;
        tableBody.appendChild(tr);
      })
    }

    function contactCell(phone, email){
      let html = '';
      if(phone){
        const parts = phone.split(/[;,|\n]+/).map(s=>s.trim()).filter(Boolean);
        html += parts.map(p=>`<div><a href="tel:${p}">${escapeHtml(p)}</a> <span><a class="small" href="https://wa.me/91${p.replace(/[^0-9]/g,'')}" target="_blank"><i class="fa-brands fa-whatsapp" style="width: 20px; height:20px; color:green"></i></a></span></div>`).join('');
      }
      if(email){
        const emails = email.split(/[;,|\n]+/).map(s=>s.trim()).filter(Boolean);
        html += emails.map(e=>`<div><a href="mailto:${escapeHtml(e)}">${escapeHtml(e)}</a></div>`).join('');
      }
      return html;
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"]+/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function updateSortIndicators(){
      document.querySelectorAll('th[data-sort] .sort-indicator').forEach(indicator => {
        const th = indicator.parentElement;
        const column = th.getAttribute('data-sort');
        if(column === sortColumn){
          indicator.textContent = sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
          indicator.classList.add('active');
        } else {
          indicator.textContent = '‚ñ≤';
          indicator.classList.remove('active');
        }
      });
    }

    function sortData(rows){
      return rows.sort((a, b) => {
        let aVal = (a[sortColumn] || '').toString().toLowerCase();
        let bVal = (b[sortColumn] || '').toString().toLowerCase();
        const comparison = aVal.localeCompare(bVal);
        return sortDirection === 'asc' ? comparison : -comparison;
      });
    }

    function applyFilters(){
      const q = searchBox.value.toLowerCase();
      const cat = filterCat.value;
      let rows = data.filter(r=>{
        const blob = `${r.category} ${r.organization} ${r.person} ${r.role} ${r.address} ${r.phone} ${r.email} ${r.notes}`.toLowerCase();
        const okQ = !q || blob.includes(q);
        const okC = !cat || r.category === cat;
        return okQ && okC;
      });
      rows = sortData(rows);
      renderTable(rows);
      updateSortIndicators();
    }

    function populateCategoryFilter(){
      const cats = Array.from(new Set(data.map(d=>d.category).filter(Boolean))).sort();
      filterCat.innerHTML = '<option value="">All categories</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    function renderNotices(noticeList){
      if(!noticeList || !noticeList.length){
        noticesArea.innerHTML = '<p class="small">(No notices yet)</p>';
        return;
      }
      noticesArea.innerHTML = noticeList.map(n => {
        const date = n.Date || '';
        const title = escapeHtml(n.Title || '');
        const notice = escapeHtml(n.Notice || '').replace(/\n/g, '<br>');
        const link = n.Link || '';
        const linkHtml = link ? `<div style="margin-top:10px;padding-top:10px;border-top:1px solid #f0d98e"><a href="${escapeHtml(link)}" target="_blank" style="color:var(--accent);text-decoration:none;font-size:13px"><i class="fa-solid fa-paperclip"></i> View Attachment</a></div>` : '';
        return `
          <div class="notice" style="margin-bottom:15px">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
              <strong>${title}</strong>
              <span class="small" style="white-space:nowrap;margin-left:10px">${date}</span>
            </div>
            <div style="font-size:14px;line-height:1.6">${notice}</div>
            ${linkHtml}
          </div>
        `;
      }).join('');
    }

    function renderVegMarket(marketList){
      const vegmarketArea = document.getElementById('vegmarket-area');

      if(!marketList || !marketList.length){
        vegmarketArea.innerHTML = '<p class="small">(No data available)</p>';
        return;
      }

      // Group by Day
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const grouped = {};
      days.forEach(day => grouped[day] = []);

      marketList.forEach(item => {
        const day = item.Day || '';
        if (grouped[day]) {
          grouped[day].push(item);
        }
      });

      vegmarketArea.innerHTML = `
        <table style="width:100%;border-collapse:collapse;font-size:14px">
          <thead>
            <tr style="background:#f5f5f5;border-bottom:2px solid #ddd">
              <th style="padding:10px;text-align:left;font-weight:600">Day</th>
              <th style="padding:10px;text-align:left;font-weight:600">Village/Location</th>
            </tr>
          </thead>
          <tbody>
            ${days.map(day => {
              const villages = grouped[day].map(v => escapeHtml(v.Village || '')).filter(Boolean);
              if (villages.length === 0) return '';
              return `
                <tr style="border-bottom:1px solid #eee">
                  <td style="padding:10px;font-weight:500">${day}</td>
                  <td style="padding:10px">${villages.join(', ')}</td>
                </tr>
              `;
            }).filter(Boolean).join('')}
          </tbody>
        </table>
      `;
    }

    function renderBRTS(brtsList){
      const brtsArea = document.getElementById('brts-area');

      if(!brtsList || !brtsList.length){
        brtsArea.innerHTML = '<p class="small">(No data available)</p>';
        return;
      }

      const link = brtsList[0].Link || '';

      if(!link){
        brtsArea.innerHTML = '<p class="small">(No schedule available)</p>';
        return;
      }

      brtsArea.innerHTML = `
        <div style="padding:15px;background:#f9f9f9;border-radius:8px;border-left:4px solid var(--accent)">
          <p style="margin:0 0 10px 0;font-size:14px">View the complete Tatpar BRTS schedule:</p>
          <a href="${escapeHtml(link)}" target="_blank" style="display:inline-flex;align-items:center;gap:8px;color:var(--accent);text-decoration:none;font-weight:500">
            <i class="fa-solid fa-file-pdf"></i> Download Schedule (PDF)
          </a>
        </div>
      `;
    }

    function renderLinks(linksList){
      const linksArea = document.getElementById('links-area');

      if(!linksList || !linksList.length){
        linksArea.innerHTML = '<p class="small">(No links available)</p>';
        return;
      }

      linksArea.innerHTML = `
        <table style="width:100%;border-collapse:collapse;font-size:14px">
          <thead>
            <tr style="background:#f5f5f5;border-bottom:2px solid #ddd">
              <th style="padding:10px;text-align:left;font-weight:600">Link</th>
              <th style="padding:10px;text-align:left;font-weight:600">Notes</th>
            </tr>
          </thead>
          <tbody>
            ${linksList.map(item => {
              const link = item.Link || '';
              const label = escapeHtml(item.Label || 'Link');
              const notes = escapeHtml(item.Notes || '');

              return `
                <tr style="border-bottom:1px solid #eee">
                  <td style="padding:10px">
                    ${link ? `<a href="${escapeHtml(link)}" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:500">${label} <i class="fa-solid fa-external-link-alt" style="font-size:11px"></i></a>` : label}
                  </td>
                  <td style="padding:10px">${notes}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    async function loadNotices(){
      try {
        const { data: json, fromCache } = await fetchDataWithCache(NOTICE_URL, CACHE_KEYS.notices);
        notices = json;
        renderNotices(notices);

        // Update last updated indicator
        const timestamp = localStorage.getItem(CACHE_KEYS.notices + '_timestamp');
        updateLastUpdatedUI('notices-last-updated', timestamp, fromCache);
      } catch (err) {
        console.error('Failed to load notices', err);
        noticesArea.innerHTML = '<p class="small">(Failed to load notices)</p>';
      }
    }

    async function loadVegMarket(){
      try {
        const { data: json, fromCache } = await fetchDataWithCache(VEGMARKET_URL, CACHE_KEYS.vegmarket);
        renderVegMarket(json);

        // Update last updated indicator
        const timestamp = localStorage.getItem(CACHE_KEYS.vegmarket + '_timestamp');
        updateLastUpdatedUI('vegmarket-last-updated', timestamp, fromCache);
      } catch (err) {
        console.error('Failed to load vegetable market', err);
        document.getElementById('vegmarket-area').innerHTML = '<p class="small">(Failed to load data)</p>';
      }
    }

    async function loadBRTS(){
      try {
        const { data: json, fromCache } = await fetchDataWithCache(BRTS_URL, CACHE_KEYS.brts);
        renderBRTS(json);

        // Update last updated indicator
        const timestamp = localStorage.getItem(CACHE_KEYS.brts + '_timestamp');
        updateLastUpdatedUI('brts-last-updated', timestamp, fromCache);
      } catch (err) {
        console.error('Failed to load BRTS schedule', err);
        document.getElementById('brts-area').innerHTML = '<p class="small">(Failed to load data)</p>';
      }
    }

    async function loadLinks(){
      try {
        const { data: json, fromCache } = await fetchDataWithCache(LINKS_URL, CACHE_KEYS.links);
        renderLinks(json);

        // Update last updated indicator
        const timestamp = localStorage.getItem(CACHE_KEYS.links + '_timestamp');
        updateLastUpdatedUI('links-last-updated', timestamp, fromCache);
      } catch (err) {
        console.error('Failed to load links', err);
        document.getElementById('links-area').innerHTML = '<p class="small">(Failed to load links)</p>';
      }
    }

    async function loadLocalContactDir(){
      showLoading(true);
      try {
        const { data: json, fromCache } = await fetchDataWithCache(LOCAL_CONTACT_DIR_URL, CACHE_KEYS.contacts);
        data = json.map(r => ({
          category: r['Category'] || '',
          organization: r['Organization / Place / Service'] || '',
          person: r['Person / Contact Name'] || '',
          role: '',
          address: r['Address / Area'] || '',
          phone: [r['Phone 1'], r['Phone 2'], r['Phone 3']].filter(Boolean).join(', '),
          email: r['Email'] || '',
          notes: r['Notes'] || ''
        })).filter(r => r.organization || r.person);

        populateCategoryFilter();
        applyFilters();
        showLoading(false);

        // Update last updated indicator
        const timestamp = localStorage.getItem(CACHE_KEYS.contacts + '_timestamp');
        updateLastUpdatedUI('directory-last-updated', timestamp, fromCache);
      } catch (err) {
        console.error('Load failed', err);
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px">Failed to load data. Please refresh the page.</td></tr>';
        showLoading(false);
      }
    }

    searchBox.addEventListener('input', applyFilters);
    filterCat.addEventListener('change', applyFilters);

    // Add click handlers to sortable column headers
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.getAttribute('data-sort');
        if(sortColumn === column){
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }
        applyFilters();
      });
    });

    loadLocalContactDir();
    loadNotices();
    loadLinks();
    loadVegMarket();
    loadBRTS();

    // Hamburger menu toggle
    const hamburger = document.querySelector('.hamburger');
    const navLinks = document.querySelector('.nav-links');

    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      navLinks.classList.toggle('active');
    });

    // Close menu when clicking on a link
    document.querySelectorAll('.nav-links a').forEach(link => {
      link.addEventListener('click', () => {
        hamburger.classList.remove('active');
        navLinks.classList.remove('active');
      });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('nav')) {
        hamburger.classList.remove('active');
        navLinks.classList.remove('active');
      }
    });
  </script>
</body>
</html>

